<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="NeoFinance - Modern Expense Tracker application to manage your finances">
    <title>NeoFinance | Modern Expense Tracker</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style> 
        /* --- ENHANCED CALCULATOR STYLES --- */
        .calculator-overlay {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0; 
            top: 0;
            width: 100vw; 
            height: 100vh;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            align-items: center; 
            justify-content: center;
            transition: all 0.3s ease;
            opacity: 0;
        }
        
        .calculator-overlay.active {
            display: flex;
            opacity: 1;
        }
        
        .calculator-container {
            position: relative;
            width: 100%;
            max-width: 400px; /* Increased width */
            padding: 20px;
        }
        
        .calculator {
            width: 100%;
            background: linear-gradient(145deg, #1a1d2e, #22273a);
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3),
                        0 0 0 1px rgba(255, 255, 255, 0.05);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        
        .calculator-overlay.active .calculator {
            transform: scale(1);
        }
        
        .calculator-header {
            text-align: center;
            margin-bottom: 5px;
        }
        
        .calculator-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin: 0;
            background: linear-gradient(90deg, #00dbde, #fc00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 1px;
        }
        
        .calculator-display-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 5px;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .calculator-display-container::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
        }
        
        .calculator-display {
            background: transparent;
            border: none;
            font-size: 1.8rem;
            text-align: right;
            color: #fff;
            font-family: 'Roboto Mono', monospace;
            font-weight: 400;
            width: 100%;
            outline: none;
            min-height: 36px;
            text-shadow: 0 0 5px rgba(255,255,255,0.1);
            letter-spacing: 1px;
        }
        
        .calculator-display.error {
            color: #ff6b6b;
        }
        
        .calculator-history {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.6);
            text-align: right;
            margin-bottom: 5px;
            height: 18px;
            font-family: 'Roboto Mono', monospace;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .memory-indicator {
            position: absolute;
            top: 10px;
            left: 15px;
            color: #00dbde;
        }
        
        .memory-indicator.active {
            opacity: 1;
        }
        
        .calculator-mode-toggle {
            display: none; /* Hide the mode toggle */
        }
        
        .mode-btn {
            display: none; /* Hide mode buttons */
        }
        
        .mode-btn.active {
            /* No styles needed as it's hidden */
        }
        
        .calculator-buttons {
            display: grid;
            grid-template-columns: repeat(6, 1fr); /* 6 columns for better separation */
            grid-template-rows: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 5px;
        }

        
        .calculator-buttons button {
            padding: 14px 0;
            font-size: 1.15rem;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1); /* Add a subtle border */
            box-sizing: border-box; /* Include border in element's total width and height */
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            font-weight: 500;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
            outline: none;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            text-align: center; /* Ensure text is centered */
        }

        .calculator-buttons button::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            opacity: 0;
            transition: opacity 0.2s;
        }

        /* Adjust button order and layout */
        .calculator-buttons button:nth-child(1) { order: 1; }  /* C */
        .calculator-buttons button:nth-child(2) { order: 2; }  /* / */
        .calculator-buttons button:nth-child(3) { order: 3; }  /* sin */
        .calculator-buttons button:nth-child(4) { order: 4; }  /* cos */
        .calculator-buttons button:nth-child(5) { order: 5; }  /* 7 */
        .calculator-buttons button:nth-child(6) { order: 6; }  /* 8 */
        .calculator-buttons button:nth-child(7) { order: 7; }  /* 9 */
        .calculator-buttons button:nth-child(8) { order: 8; }  /* * */
        .calculator-buttons button:nth-child(9) { order: 9; }  /* tan */
        .calculator-buttons button:nth-child(10){ order: 10; } /* log */
        .calculator-buttons button:nth-child(11){ order: 11; } /* 4 */
        .calculator-buttons button:nth-child(12){ order: 12; } /* 5 */
        .calculator-buttons button:nth-child(13){ order: 13; } /* 6 */
        .calculator-buttons button:nth-child(14){ order: 14; } /* - */
        .calculator-buttons button:nth-child(15){ order: 15; } /* ln */
        .calculator-buttons button:nth-child(16){ order: 16; } /* Tax */
        
        .calculator-buttons button:hover::after {
            opacity: 1;
        }
        
        .calculator-buttons button:active {
            transform: scale(0.95);
        }

        /* New grid arrangement for numbers and operators */
        /* Numbers in center, operators on right, Apply at bottom */
        .calculator-buttons .num-0 { grid-column: 2 / 4; grid-row: 5; }
        .calculator-buttons .num-1 { grid-column: 1; grid-row: 4; }
        .calculator-buttons .num-2 { grid-column: 2; grid-row: 4; }
        .calculator-buttons .num-3 { grid-column: 3; grid-row: 4; }
        .calculator-buttons .num-4 { grid-column: 1; grid-row: 3; }
        .calculator-buttons .num-5 { grid-column: 2; grid-row: 3; }
        .calculator-buttons .num-6 { grid-column: 3; grid-row: 3; }
        .calculator-buttons .num-7 { grid-column: 1; grid-row: 2; }
        .calculator-buttons .num-8 { grid-column: 2; grid-row: 2; }
        .calculator-buttons .num-9 { grid-column: 3; grid-row: 2; }
        .calculator-buttons .decimal { grid-column: 4; grid-row: 5; }
        .calculator-buttons .equals { grid-column: 5; grid-row: 5; }
        .calculator-buttons .apply { grid-column: 1 / 7; grid-row: 6; }
        /* Operators on right */
        .calculator-buttons .operator-add { grid-column: 6; grid-row: 2; }
        .calculator-buttons .operator-sub { grid-column: 6; grid-row: 3; }
        .calculator-buttons .operator-mul { grid-column: 6; grid-row: 4; }
        .calculator-buttons .operator-div { grid-column: 6; grid-row: 1; }
        .calculator-buttons .operator-pct { grid-column: 5; grid-row: 1; }
        .calculator-buttons .operator-sqrt { grid-column: 4; grid-row: 1; }
        .calculator-buttons .operator-neg { grid-column: 4; grid-row: 4; }
        /* Clear and memory top left */
        .calculator-buttons .clear { grid-column: 1; grid-row: 1; }
        
        /* Responsive adjustments */
        @media (max-width: 600px) {
            .calculator-container {
                max-width: 98vw;
            }
            .calculator {
                padding: 10px;
            }
            .calculator-buttons button {
                padding: 10px 0;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Main Container -->
    <main class="container">
        <!-- Left Panel -->
        <div class="panel left-panel">
            <div class="profile-section">
                <div class="avatar" aria-hidden="true">
                    <i class="fas fa-user" aria-hidden="true"></i>
                </div>
                <h3 class="welcome-text">Welcome back</h3>
                <div class="date-display" id="currentDate" aria-live="polite"></div>
            </div>

            <div class="balance-card">
                <div class="balance-header">
                    <h2>Total Balance</h2>
                    <div class="balance-actions">
                        <button id="exportBtn" class="action-btn" title="Export Data" aria-label="Export transaction data">
                            <i class="fas fa-download" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>
                <div class="balance-amount" id="balanceAmount" aria-live="polite">$0.00</div>
                <div class="balance-summary">
                    <div class="summary-item income">
                        <div class="summary-icon">
                            <i class="fas fa-arrow-up" aria-hidden="true"></i>
                        </div>
                        <div class="summary-details">
                            <p class="summary-label">Income</p>
                            <p class="summary-value" id="totalIncome">$0.00</p>
                        </div>
                    </div>
                    <div class="summary-item expense">
                        <div class="summary-icon">
                            <i class="fas fa-arrow-down" aria-hidden="true"></i>
                        </div>
                        <div class="summary-details">
                            <p class="summary-label">Expense</p>
                            <p class="summary-value" id="totalExpense">$0.00</p>
                        </div>
                    </div>
                </div>
            </div>

            <button id="openTrendModalBtn" class="btn btn-add" style="margin:12px auto 0 auto;display:block;">View Income & Expense Trend</button>

            <div class="modal" id="trendModal" role="dialog" aria-modal="true" aria-labelledby="trendModalTitle" hidden>
                <div class="modal-content" style="max-width:700px;">
                    <div class="modal-header">
                        <h3 id="trendModalTitle">Income & Expense Trend</h3>
                        <button class="close-modal" id="closeTrendModal" aria-label="Close trend chart">×</button>
                    </div>
                    <div class="chart-modal-body">
                        <div class="chart-placeholder">
                            <canvas id="trendChart" style="width:100%;height:260px;"></canvas>
                            <div class="empty-chart-message" id="trendEmptyMsg">Add transactions to see trend</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="manual-section">
                <div class="manual-header">
                    <h3>User Manual</h3>
                    <button id="toggleManual" class="action-btn" title="Toggle User Manual" aria-expanded="false" aria-controls="manualContent">
                        <i class="fas fa-book" aria-hidden="true"></i>
                    </button>
                </div>
                <div class="manual-content" id="manualContent" style="display: none;">
                    <h4>NeoFinance Quick User Guide</h4>
                    <ul>
                        <li><strong>Add Transactions:</strong> Enter date, type, amount, category, and description. Use the calculator for quick calculations. Click <b>Add Transaction</b>.</li>
                        <li><strong>Edit/Delete:</strong> Click a transaction to edit or delete it.</li>
                        <li><strong>View Trends:</strong> Click <b>View Income & Expense Trend</b> for a monthly bar graph.</li>
                        <li><strong>Export Data:</strong> Use the download icon to export transactions as PDF.</li>
                        <li><strong>Theme:</strong> Toggle light/dark mode with the moon/sun icon.</li>
                        <li><strong>Calculator:</strong> Open the futuristic calculator with basic/scientific modes. Features include memory functions (M+, M-, MR, MC), operations (+, -, *, /, %, √, ±), scientific functions (sin, cos, tan, log, ln, x², xʸ, π, e), and tax calculation. Use Esc to clear, Backspace to delete, Enter to calculate, and arrow keys to navigate. Apply results to the transaction form.</li>
                        <li><strong>Accessibility:</strong> Use <b>Tab</b> to navigate, <b>Enter</b> to submit, <b>Escape</b> to clear/close, and arrow keys for calculator buttons.</li>
                    </ul>
                    <p style="margin-top:10px;"><b>Tip:</b> Data is stored in your browser. Export regularly to avoid loss.</p>
                </div>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="panel right-panel">
            <div class="heading">
                <h1>NeoFinance <span class="subtitle">Expense Tracker</span></h1>
                <div class="flex-row">
                    <button id="openCalculatorBtn" class="action-btn" title="Open Futuristic Calculator" aria-label="Open calculator">
                        <i class="fas fa-calculator" aria-hidden="true"></i>
                    </button>
                    <button class="theme-toggle" id="themeToggle" aria-label="Toggle dark mode">
                        <i class="fas fa-moon" id="themeToggleIcon" aria-hidden="true"></i>
                    </button>
                </div>
            </div>

            <div class="transaction-form-container">
                <h2>Add New Transaction</h2>
                <form id="transactionForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="transactionDate">Date</label>
                            <input type="date" id="transactionDate" required aria-required="true">
                        </div>
                        <div class="form-group">
                            <label for="transactionType">Type</label>
                            <select id="transactionType" required aria-required="true">
                                <option value="income">Income</option>
                                <option value="expense">Expense</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="transactionAmount">Amount ($)</label>
                            <input type="number" id="transactionAmount" min="0.01" step="0.01" placeholder="0.00" required aria-required="true">
                        </div>
                        <div class="form-group">
                            <label for="transactionCategory">Category</label>
                            <select id="transactionCategory" required aria-required="true">
                                <option value="Salary" data-type="income">Salary</option>
                                <option value="Freelance" data-type="income">Freelance</option>
                                <option value="Investment" data-type="income">Investment</option>
                                <option value="Gift" data-type="income">Gift</option>
                                <option value="Other Income" data-type="income">Other Income</option>
                                <option value="Food" data-type="expense">Food</option>
                                <option value="Transportation" data-type="expense">Transportation</option>
                                <option value="Housing" data-type="expense">Housing</option>
                                <option value="Entertainment" data-type="expense">Entertainment</option>
                                <option value="Shopping" data-type="expense">Shopping</option>
                                <option value="Utilities" data-type="expense">Utilities</option>
                                <option value="Health" data-type="expense">Health</option>
                                <option value="Education" data-type="expense">Education</option>
                                <option value="Travel" data-type="expense">Travel</option>
                                <option value="Tax" data-type="expense">Tax</option>
                                <option value="Other Expense" data-type="expense">Other Expense</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="transactionDescription">Description</label>
                        <input type="text" id="transactionDescription" placeholder="Enter transaction description" required aria-required="true">
                    </div>
                    <div class="form-actions">
                        <button type="button" id="cancelTransaction" class="btn btn-cancel">Cancel</button>
                        <button type="submit" class="btn btn-add">Add Transaction</button>
                        <p class="reload-message">Please RELOAD after adding transactions</p>
                    </div>
                </form>
            </div>

            <div class="transactions-container">
                <div class="transactions-header">
                    <h2>Transaction History</h2>
                    <div class="filter-controls">
                        <div class="search-container">
                            <label for="searchTransactions" class="sr-only">Search transactions</label>
                            <input type="text" id="searchTransactions" placeholder="Search transactions..." aria-label="Search transactions">
                            <i class="fas fa-search" aria-hidden="true"></i>
                        </div>
                        <label for="categoryFilter" class="sr-only">Filter by category</label>
                        <select id="categoryFilter" title="Filter by category" aria-label="Filter by category">
                            <option value="all">All Categories</option>
                            <option value="Salary">Salary</option>
                            <option value="Freelance">Freelance</option>
                            <option value="Investment">Investment</option>
                            <option value="Gift">Gift</option>
                            <option value="Other Income">Other Income</option>
                            <option value="Food">Food</option>
                            <option value="Transportation">Transportation</option>
                            <option value="Housing">Housing</option>
                            <option value="Entertainment">Entertainment</option>
                            <option value="Shopping">Shopping</option>
                            <option value="Utilities">Utilities</option>
                            <option value="Health">Health</option>
                            <option value="Education">Education</option>
                            <option value="Travel">Travel</option>
                            <option value="Tax">Tax</option>
                            <option value="Other Expense">Other Expense</option>
                        </select>
                        <label for="typeFilter" class="sr-only">Filter by type</label>
                        <select id="typeFilter" title="Filter by type" aria-label="Filter by transaction type">
                            <option value="all">All Types</option>
                            <option value="income">Income</option>
                            <option value="expense">Expense</option>
                        </select>
                    </div>
                </div>
                
                <div class="transactions-list" id="transactionsList" aria-live="polite">
                    <div class="empty-state">
                        <i class="fas fa-receipt empty-icon" aria-hidden="true"></i>
                        <p>No transactions yet. Add a transaction to get started.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal for editing transactions -->
        <div class="modal" id="editModal" role="dialog" aria-modal="true" aria-labelledby="editModalTitle" hidden>
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="editModalTitle">Edit Transaction</h2>
                    <button class="close-modal" aria-label="Close modal">×</button>
                </div>
                <form id="editTransactionForm">
                    <input type="hidden" id="editTransactionId">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editTransactionDate">Date</label>
                            <input type="date" id="editTransactionDate" required aria-required="true">
                        </div>
                        <div class="form-group">
                            <label for="editTransactionType">Type</label>
                            <select id="editTransactionType" required aria-required="true">
                                <option value="income">Income</option>
                                <option value="expense">Expense</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editTransactionAmount">Amount ($)</label>
                            <input type="number" id="editTransactionAmount" min="0.01" step="0.01" placeholder="0.00" required aria-required="true">
                        </div>
                        <div class="form-group">
                            <label for="editTransactionCategory">Category</label>
                            <select id="editTransactionCategory" required aria-required="true">
                                <option value="Salary" data-type="income">Salary</option>
                                <option value="Freelance" data-type="income">Freelance</option>
                                <option value="Investment" data-type="income">Investment</option>
                                <option value="Gift" data-type="income">Gift</option>
                                <option value="Other Income" data-type="income">Other Income</option>
                                <option value="Food" data-type="expense">Food</option>
                                <option value="Transportation" data-type="expense">Transportation</option>
                                <option value="Housing" data-type="expense">Housing</option>
                                <option value="Entertainment" data-type="expense">Entertainment</option>
                                <option value="Shopping" data-type="expense">Shopping</option>
                                <option value="Utilities" data-type="expense">Utilities</option>
                                <option value="Health" data-type="expense">Health</option>
                                <option value="Education" data-type="expense">Education</option>
                                <option value="Travel" data-type="expense">Travel</option>
                                <option value="Tax" data-type="expense">Tax</option>
                                <option value="Other Expense" data-type="expense">Other Expense</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editTransactionDescription">Description</label>
                        <input type="text" id="editTransactionDescription" placeholder="Enter transaction description" required aria-required="true">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-add">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- Calculator Overlay -->
    <div id="calculatorOverlay" class="calculator-overlay">
        <div class="calculator-container">
            <div id="calculator" class="calculator" role="application" aria-label="Futuristic Calculator">
                <div class="calculator-header">
                    <h2 class="calculator-title">NeoCalculator</h2>
                 </div>
                <div class="calculator-display-container">
                    <div id="memoryIndicator" class="memory-indicator" aria-hidden="true">M</div>
                    <div id="calculatorHistory" class="calculator-history" aria-label="Calculation history"></div>
                    <input id="calculatorDisplay" class="calculator-display" role="textbox" aria-live="polite" value="0" readonly>
                </div>
                <div id="calculatorButtonsBasic" class="calculator-buttons basic-mode" role="grid">
                    <button class="clear" aria-label="Clear all">C</button>
                    <button class="operator operator-div" aria-label="Divide">/</button>
                    <button class="operator operator-pct" aria-label="Percentage">%</button>
                    <button class="operator operator-sqrt" aria-label="Square Root">√</button>
                    <button class="num-7">7</button>
                    <button class="num-8">8</button>
                    <button class="num-9">9</button>
                    <button class="operator operator-mul" aria-label="Multiply">*</button>
                    <button class="num-4">4</button>
                    <button class="num-5">5</button>
                    <button class="num-6">6</button>
                    <button class="operator operator-sub" aria-label="Subtract">-</button>
                    <button class="num-1">1</button>
                    <button class="num-2">2</button>
                    <button class="num-3">3</button>
                    <button class="operator operator-add" aria-label="Add">+</button>
                    <button class="num-0">0</button>
                    <button class="decimal" aria-label="Decimal Point">.</button>
                    <button class="operator operator-neg" aria-label="Negate">±</button>
                    <button class="equals" aria-label="Equals">=</button>
                    <button class="apply" aria-label="Apply to Transaction">Apply</button>
                </div>
                <div class="calculator-footer">
                    <p>NeoCalc v1.0 | Powered by Expense Tracker</p>
                </div>
            </div>
            <button id="closeCalculatorBtn" class="calculator-close" aria-label="Close calculator">×</button>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-content">
            <p>© 2025 NeoFinance. All rights reserved.</p>
            <p>Created by <a href="https://github.com/OPBSUTHAR" target="_blank" rel="noopener noreferrer">Omprakash Suthar with <span aria-hidden="true">♥</span><span class="sr-only">love</span></a></p>
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.7.0/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="script.js"></script>

    <script>
    // Enhanced Calculator Logic
    (function() {
        const overlay = document.getElementById('calculatorOverlay');
        const openBtn = document.getElementById('openCalculatorBtn');
        const closeBtn = document.getElementById('closeCalculatorBtn');
        const display = document.getElementById('calculatorDisplay');
        const history = document.getElementById('calculatorHistory');
        const buttonsBasic = document.getElementById('calculatorButtonsBasic');
        
        let firstOperand = null;
        let operator = null;
        let waitingForSecondOperand = false;
        let displayValue = '0';
        let lastCalculation = '';
        const taxRate = 0.1; // Default 10% tax rate

        // Enhanced keyboard shortcuts mapping
        const keyMappings = {
            '0': '0', '1': '1', '2': '2', '3': '3', '4': '4', '5': '5',
            '6': '6', '7': '7', '8': '8', '9': '9',
            '.': '.',
            '+': '+', '-': '-', '*': '*', '/': '/',
            '%': '%', 'r': '√',
            '=': '=', 'Enter': '=',
            'Escape': 'C', 'Backspace': 'backspace',
            'a': 'Apply'
        };

        // Update display with better formatting
        function updateDisplay() {
            // Format large numbers with commas and handle errors
            if (displayValue !== 'Error' && !isNaN(displayValue)) {
                const num = parseFloat(displayValue);
                if (!isNaN(num)) {
                    display.value = num.toLocaleString('en-US', {
                        maximumFractionDigits: 8,
                        minimumFractionDigits: displayValue.includes('.') ? 1 : 0
                    });
                } else {
                    display.value = displayValue;
                }
            } else {
                display.value = displayValue;
            }
            display.classList.toggle('error', displayValue === 'Error');
            // Dynamic font sizing
            const length = display.value.replace(/,/g, '').length;
            if (length > 16) display.style.fontSize = '1.4rem';
            else if (length > 12) display.style.fontSize = '1.8rem';
            else if (length > 8) display.style.fontSize = '2.2rem';
            else display.style.fontSize = '2.5rem';
        }

        // Enhanced calculation logic
        function performCalculation(first, op, second) {
            try {
                const firstNum = typeof first === 'string' ? parseFloat(first.replace(/,/g, '')) : first;
                const secondNum = typeof second === 'string' ? parseFloat(second.replace(/,/g, '')) : second;
                switch (op) {
                    case '+': return firstNum + secondNum;
                    case '-': return firstNum - secondNum;
                    case '*': return firstNum * secondNum;
                    case '/': 
                        if (secondNum === 0) throw new Error('Division by zero');
                        return firstNum / secondNum;
                    case '%': return (firstNum * secondNum) / 100;
                    case '√': 
                        if (firstNum < 0) throw new Error('Invalid square root');
                        return Math.sqrt(firstNum);
                    default: return secondNum;
                }
            } catch (error) {
                return 'Error';
            }
        }

        // Update history with better formatting
        function updateHistory() {
            history.textContent = lastCalculation;
            history.title = lastCalculation;
        }

        // Handle calculator button clicks
        function handleButtonClick(value) {
            // Handle numbers and decimal
            if (!isNaN(value) || value === '.') {
                if (displayValue === 'Error' || waitingForSecondOperand) {
                    displayValue = value;
                    waitingForSecondOperand = false;
                } else {
                    displayValue = displayValue === '0' ? value : displayValue.replace(/,/g, '') + value;
                }
            }
            // Handle decimal point
            else if (value === '.') {
                if (!displayValue.includes('.')) {
                    displayValue = displayValue + '.';
                }
            }
            // Handle basic operations
            else if (["+", "-", "*", "/", "%"].includes(value)) {
                if (operator && !waitingForSecondOperand) {
                    const result = performCalculation(firstOperand, operator, displayValue);
                    lastCalculation = `${firstOperand} ${operator} ${displayValue} = ${result}`;
                    displayValue = result === 'Error' ? 'Error' : result.toString();
                    firstOperand = result === 'Error' ? null : result;
                    operator = value;
                    waitingForSecondOperand = true;
                } else {
                    firstOperand = displayValue;
                    operator = value;
                    waitingForSecondOperand = true;
                }
            }
            // Handle square root
            else if (value === '√') {
                if (!waitingForSecondOperand) {
                    const result = performCalculation(displayValue, '√', 0);
                    lastCalculation = `√(${displayValue}) = ${result}`;
                    displayValue = result === 'Error' ? 'Error' : result.toString();
                    firstOperand = null;
                    operator = null;
                    waitingForSecondOperand = false;
                }
            }
            // Handle equals
            else if (value === '=') {
                if (operator && !waitingForSecondOperand) {
                    const result = performCalculation(firstOperand, operator, displayValue);
                    lastCalculation = `${firstOperand} ${operator} ${displayValue} = ${result}`;
                    displayValue = result === 'Error' ? 'Error' : result.toString();
                    firstOperand = null;
                    operator = null;
                    waitingForSecondOperand = false;
                }
            }
            // Handle clear
            else if (value === 'C') {
                displayValue = '0';
                firstOperand = null;
                operator = null;
                waitingForSecondOperand = false;
                lastCalculation = '';
            }
            // Handle sign change
            else if (value === '±') {
                displayValue = (parseFloat(displayValue.replace(/,/g, '')) * -1).toString();
            }
            // Handle backspace
            else if (value === 'backspace') {
                if (displayValue !== 'Error' && !waitingForSecondOperand) {
                    const newValue = displayValue.replace(/,/g, '').slice(0, -1);
                    displayValue = newValue.length > 0 ? newValue : '0';
                }
            }
            // Handle apply to transaction
            else if (value === 'Apply') {
                if (displayValue !== 'Error') {
                    const result = parseFloat(displayValue.replace(/,/g, ''));
                    if (confirm(`Apply $${result.toFixed(2)} to transaction amount?`)) {
                        transactionAmount.value = Math.abs(result).toFixed(2);
                        transactionType.value = result >= 0 ? 'income' : 'expense';
                        closeCalculator();
                        transactionAmount.focus();
                    }
                }
            }
            updateDisplay();
            updateHistory();
        }

        // Enhanced keyboard handler
        function handleKeyDown(e) {
            if (!overlay.classList.contains('active')) return;
            const key = e.key;
            let handled = false;
            // Main key mappings
            if (!handled && keyMappings[key]) {
                handleButtonClick(keyMappings[key]);
                handled = true;
            }
            // Arrow key navigation
            if (!handled && ['ArrowRight', 'ArrowLeft', 'ArrowUp', 'ArrowDown'].includes(key)) {
                const activeButtons = buttonsBasic;
                const buttonsList = Array.from(activeButtons.querySelectorAll('button:not(.scientific-hidden)'));
                const current = document.activeElement;
                const currentIndex = buttonsList.indexOf(current);
                let nextIndex;
                const columns = 6;
                if (key === 'ArrowRight') nextIndex = currentIndex + 1;
                else if (key === 'ArrowLeft') nextIndex = currentIndex - 1;
                else if (key === 'ArrowUp') nextIndex = currentIndex - columns;
                else if (key === 'ArrowDown') nextIndex = currentIndex + columns;
                if (nextIndex >= 0 && nextIndex < buttonsList.length) {
                    buttonsList[nextIndex].focus();
                    handled = true;
                }
            }
            if (handled) {
                e.preventDefault();
                e.stopPropagation();
            }
        }

        // Open calculator with better focus management
        function openCalculator() {
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            document.addEventListener('keydown', handleKeyDown);
            display.setAttribute('tabindex', '0');
            display.focus();
        }

        // Close calculator with proper cleanup
        function closeCalculator() {
            overlay.classList.remove('active');
            document.body.style.overflow = '';
            document.removeEventListener('keydown', handleKeyDown);
            openBtn.focus();
            displayValue = '0';
            firstOperand = null;
            operator = null;
            waitingForSecondOperand = false;
            lastCalculation = '';
            updateDisplay();
            updateHistory();
        }

        // Initialize calculator with proper tabindex and ARIA attributes
        function initCalculator() {
            // Set tabindex and ARIA attributes for all buttons
            const calculatorButtons = document.querySelectorAll('.calculator-buttons button');
            calculatorButtons.forEach(button => {
                button.setAttribute('tabindex', '0');
                if (!button.getAttribute('aria-label')) {
                    button.setAttribute('aria-label', button.textContent);
                }
            });
            updateDisplay();
            updateHistory();
        }

        // Event listeners
        if (openBtn) openBtn.addEventListener('click', openCalculator);
        if (closeBtn) closeBtn.addEventListener('click', closeCalculator);

        // Single button click listener for all buttons
        const allButtons = document.querySelectorAll('.calculator-buttons button');
        allButtons.forEach(button => button.addEventListener('click', (e) => handleButtonClick(e.target.textContent)));

        // Initialize calculator
        initCalculator();
    })();
</script>
</body>
</html>